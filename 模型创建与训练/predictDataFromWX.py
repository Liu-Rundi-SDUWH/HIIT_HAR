from math import exp
from csv import reader
from random import seed

# Load a CSV file
def load_csv(filename):
    dataset = list()
    with open(filename, 'r') as file:
        csv_reader = reader(file)
        for row in csv_reader:
            if not row:
                continue
            dataset.append(row)
    return dataset

# Convert string column to float
def str_column_to_float(dataset, column):
    for row in dataset:
        row[column] = float(row[column].strip())

# Convert string column to integer
def str_column_to_int(dataset):
    for row in dataset:
        row[-1] = int(row[-1])

# Forward propagate input to a network output
def forward_propagate(network, row):
    inputs = row
    for layer in network:
        new_inputs = []
        for neuron in layer:

            # activation
            weights = neuron['weights']
            activation = weights[-1]
            for i in range(len(weights) - 1):
                activation += weights[i] * inputs[i]
            # transfer
            neuron['output'] = 1.0 / (1.0 + exp(-activation))

            new_inputs.append(neuron['output'])
        inputs = new_inputs
    return inputs


def predict(network, row):
    outputs = forward_propagate(network, row)
    print('out', outputs)
    return outputs.index(max(outputs))

# Test Bp############################################################################
seed(1)
# load and prepare data
filename = 'outdataxiu.csv'
test_data = load_csv(filename)
for i in range(len(test_data[0]) - 1):
    str_column_to_float(test_data, i)
str_column_to_int(test_data)
#训练好的network
network = [[{'weights': [0.11086528965344682, 0.8433697408117523, 0.7749870298900406, 0.2670348387900236, 0.5199691265206279, 0.46049421580049016, 0.6655856727324365, 0.8162641176952314, 0.10836163204082823, 0.043073467650488695, 0.8276961659621755, 0.43051365452539475, 0.7579497496303926, 0.00030673756040478027, 0.4515130907396507, 0.727076179441948, 0.23404300578711631, 0.9453392118612693, 0.903464431063607, 0.031215122700619404, 0.02934995268110613, 0.5429003413275479, 0.9362801003840834, 0.37849004824802757, 0.20798657903543868, 0.4196838384692563, 0.036908404867556525, 0.24614178584559893, 0.4561775803616628, 0.5039816242896316, 0.24051043127193006, 0.23678592742921817, 0.22516754375450224, 0.4649253576734344, 0.2889323112975726, 0.03224326658844734, 0.839047450215107, 0.5562363353311603, 0.6364429159339664, 0.18296118809263812, 0.9820288435149302, 0.8506390777146082, 0.11776935473927441, 0.6128332312336296], 'output': 0.9994768680775805, 'delta': 8.381133521591103e-09}, {'weights': [0.7358786485278085, 0.7099512674877425, 0.9443419654587688, 0.41997500456745807, 0.826562072899713, 0.6690238282381232, 0.301331853918334, 0.5838375335532819, 0.880812587200576, 0.8442085785312924, 0.5108502602101807, 0.5922147284387341, 0.037204651060843995, 0.24543885461529413, 0.7995358203414051, 0.4152905823686942, 0.18279481850007367, 0.5559725843974753, 0.7061673475152787, 0.6756974843516222, 0.37689557253837175, 0.4414493078092415, 0.5094527937992952, 0.7863888256946154, 0.5302970468466409, 0.3995554783789123, 0.4921325867347878, 0.028175009468061434, 0.04257146988263367, 0.7033821280375475, 0.9840728014126363, 0.5939611116560773, 0.3937134047863742, 0.17031666920367303, 0.5011705973852679, 0.9845301749331968, 0.7764591094414899, 0.5476975256528938, 0.865216983664857, 0.2354699837912198, 0.5253002856909871, 0.9600415285602499, 0.5842736630094921, 1.0981754279102904], 'output': 0.9999223392472709, 'delta': -3.8392767574921674e-10}, {'weights': [0.30710917688001416, 0.5471007629140547, 0.983864479035474, 0.005294052869010251, 0.7832430360290775, 0.8205285002476919, 0.8863554144244755, 0.7399539700974767, 0.8087239359851403, 0.5186143789476443, 0.5782870506446203, 0.4371952532859619, 0.06207509236002636, 0.8751212994537554, 0.576144196836605, 0.20647799822824636, 0.5318636127571005, 0.5072721992803938, 0.36652210866344315, 0.3505051543829332, 0.5430011998882267, 0.6257565990030765, 0.6144161610263944, 0.47852869847151375, 0.05766564477537212, 0.24938661281630292, 0.18942163888776725, 0.5882281213155368, 0.8630947359044256, 0.8021292631369801, 0.7986658254324351, 0.8185775289014738, 0.25666493466625656, 0.843115684587686, 0.674563616729432, 0.09508700315089949, 0.038932851697675804, 0.03466820139730807, 0.7617389696583748, 0.25484669273793253, 0.13983376762865207, 0.6406742201137194, 0.36328738818199025, 1.9878321428062873], 'output': 0.9999334802130073, 'delta': 6.228247238416661e-10}, {'weights': [-0.5091658831220557, 1.9605373957069108, 0.750198381448616, 2.1560024807049483, 2.986886070987509, 1.5368403127797425, 2.257238875280555, 2.7876992772766287, 1.2001243142913702, 1.862932230326069, 0.5562790378984949, 0.2940333924621237, 0.1315782700090659, 0.49279689821784384, 0.2709579732472266, 1.0658460398656693, -0.2161939289477846, 0.5606068588553156, -0.05124877486678698, 0.002353448058452983, 0.5162247113736177, 0.701186937516624, 1.156943022455986, 0.21654016514311347, -0.5992843661170512, -0.36057342995970615, 0.45066747904920645, 1.6073605715241097, 0.9995706223079457, 0.8002610811357108, -0.1381897249351195, 0.5474334493792922, 0.5757276995403318, 1.060374603206508, 1.4844919013794187, 0.8873185071497284, 0.09215504844830183, -0.15044308647181684, -0.36300668612348924, 0.06179040654573293, -1.6239479225822817, -0.1140294661918311, -0.6939901355226383, -5.588757327202907], 'output': 0.9956547391732341, 'delta': -2.7714140949047504e-07}, {'weights': [0.7505929416318827, 0.41863556911476396, 0.2520614034089308, 0.006225323758948606, 0.8718671283085051, 0.0372998680204515, 0.8159413687215333, 0.9543217101582484, 0.5689764884769968, 0.16963070669404695, 0.86989671739969, 0.9747239856748365, 0.7066361968037167, 0.5110143930047033, 0.3789334501262272, 0.3509191154803219, 0.20491734833972003, 0.6736236453152475, 0.4296818422625365, 0.19322527190908279, 0.10201990557139323, 0.6678660712791766, 0.3031034321920734, 0.5024001504078786, 0.32613017910851694, 0.87095958780885, 0.897921387975978, 0.012277339561702046, 0.19740920910513268, 0.3261013268004989, 0.9871641610613023, 0.782757342245311, 0.33775790394047955, 0.2124732438718867, 0.6774675949510934, 0.8369214734017985, 0.9343994469443507, 0.34597110358129884, 0.8824404028818776, 0.6867651701620241, 0.4889863834148034, 0.9886946685729874, 0.23587702380566875, 0.9132040784379583], 'output': 0.999840655402719, 'delta': -9.84914158958635e-09}, {'weights': [0.10053662830989693, 0.16610486746915662, 0.9269848882477849, 0.2127092690556777, 0.7604402392456784, 0.6012681909741324, 0.8417803870449707, 0.37000045638957196, 0.34177732065029653, 0.29244704453338094, 0.8727760769637262, 0.6079886125733397, 0.9572508167691203, 0.891232851341584, 0.140655208821699, 0.5525732959642669, 0.12307850500539705, 0.05235763531008866, 0.07979549049938867, 0.868582362623482, 0.7926588348609217, 0.8333724857806996, 0.34091179740405136, 0.630326120885491, 0.7951175117964816, 0.3863942082890548, 0.5760703594372351, 0.2280445757298121, 0.08539751797899871, 0.26913747608593985, 0.8934090202997248, 0.56657553386352, 0.92615353525029, 0.45833157831453936, 0.2731710455174045, 0.7941032236261257, 0.8389382004199794, 0.026836206985433014, 0.6773674387669107, 0.09713306236636676, 0.13256497908666381, 0.8964024479877547, 0.05038872947789952, 1.3610109467329565], 'output': 0.9997190234280371, 'delta': -1.5929691702098631e-09}, {'weights': [1.0603422426071774, -3.9133653772091685, 0.6451145904129526, -1.6733114001832137, 2.6223512772032627, -1.6596903706912498, -1.6036196981478632, 3.6653513648843785, -1.9535206056539829, -0.7991144266359163, -0.4399621465918813, -0.8785713419281128, -2.9980609081860297, -2.491089143219976, -1.9103546896115664, 0.5695592549800735, 3.24924739476447, 3.8990391342364585, 5.2894974511778905, 1.9036391982733796, 0.6976071965248697, 0.3342984422553824, -2.177950543631276, -0.03558135798103756, 1.3146554774316064, 2.4557157182252354, 1.9233209430505174, 2.8928549437077224, -0.4430718209523821, 0.49208703142279525, 0.08876857831846803, 0.28034689155594217, 1.3237904791162596, -0.8672648967186358, 1.5317401001850266, 2.4022906518200275, -0.5783307837005461, -0.18251062140687904, -0.09303197835726262, -0.7901589053026642, 0.04556846051757351, 0.45033015822302846, 1.9855019455009666, -4.772648787111936], 'output': 0.9989105018835089, 'delta': 1.0810816255142528e-06}, {'weights': [0.8517435161514978, 0.38939298581498144, 0.27257074317834723, 0.33654044930647314, 0.32127100284245563, 0.8626317177615315, 0.9011832636666558, 0.3099141462138086, 0.35431593010704804, 0.5593048297463631, 0.54203584464689, 0.5783287569569381, 0.23437915652289684, 0.01236120590185195, 0.23972081374713441, 0.07531303328851933, 0.5132370968824288, 0.028035327648234055, 0.05604411365706539, 0.6293722502250483, 0.27864581087142976, 0.7841371280842289, 0.49490044485213086, 0.8338750460742099, 0.11189449598638145, 0.46161861573672064, 0.7851216090140946, 0.08260125188088403, 0.9637276509557459, 0.17686727143497794, 0.7702084525827652, 0.9912886894166818, 0.8241655956997455, 0.32491216549371044, 0.11158485619486228, 0.5016563054086007, 0.9042750587711257, 0.25917970953389907, 0.8622271408698843, 0.1172508880575264, 0.8676376567219126, -0.011410511022248779, 0.2803131102357818, -1.7100960140894754], 'output': 0.9907359073569003, 'delta': -3.7697280149763304e-07}, {'weights': [0.8189373527178554, 0.9048914759857462, 0.8305207373839442, 0.7319851692049004, 0.6632218377065271, 0.16908932509446123, 0.41655452852582525, 0.1292244393917581, 0.7037358250479205, 0.6539521330568933, 0.2602035620935333, 0.06717577902653855, 0.966711318566012, 0.8084899396074903, 0.5468533774089179, 0.5374015817526032, 0.8530042663551818, 0.4555696350665918, 0.39185985624787206, 0.3376218681790426, 0.2528333637191854, 0.026003646149091772, 0.649611008102361, 0.42353247278208106, 0.5786623930864677, 0.06283208447124783, 0.3496053829046191, 0.11618593393565863, 0.11063830291153852, 0.2505504865928855, 0.825619898525041, 0.3965143611939784, 0.3964965613708875, 0.6087337546956758, 0.23252746368003283, 0.005543219214099589, 0.5330337653517565, 0.5034112372274717, 0.6473165847512902, 0.4355190968071254, 0.7037602289295078, 0.7401429197105477, 0.24338587247118712, 0.4271829050389735], 'output': 0.999406829182468, 'delta': -3.7465005158759925e-08}, {'weights': [0.4846843627804074, 0.22534257796993457, 0.4173790054958819, 0.5605898356278247, 0.9060416401065977, 0.9184369496437804, 0.2754325789831333, 0.645505538736587, 0.0490025980189319, 0.07247568978345759, 0.5144128878993968, 0.8794037668894046, 0.16238950224564822, 0.7689017927510569, 0.8850249566134916, 0.31255176752418223, 0.6991150867232283, 0.8520314457973374, 0.3718427702666299, 0.7014737445734629, 0.736888439196337, 0.5969022538552992, 0.8572661844472254, 0.901833697311718, 0.9654732900078499, 0.5742981993313414, 0.17787322632942654, 0.2502074588349033, 0.21844529200795043, 0.5701451866832776, 0.7584511543079319, 0.05318632781239307, 0.6815449189307924, 0.7172018635456461, 0.34685031470426486, 0.5179046314993323, 0.17023319855791036, 0.7344749689434785, 0.04279786781782169, 0.982387858876378, 0.8145664984270886, 0.6328441946625768, 0.27148002407683725, 1.3338513624114883], 'output': 0.9999223036238413, 'delta': -6.255667740140822e-09}, {'weights': [3.5985526696907133, 3.0865421127365162, 1.1501660381658076, 1.8899215133605523, 1.147050624208729, 0.6287568774834659, 1.5238546870877776, 1.1721791902502408, 0.556264445739239, 0.7844445215200253, 0.9654292711001874, 1.044771042404729, 0.7649102168309179, 0.6344669422259781, -0.5111965963578801, 0.26515670923834894, 0.0001861262079322362, 0.5655940707232598, 0.8879872801186343, 0.4750196619287511, 0.7106338607730966, 0.33900417808076216, 1.0079559890420984, 0.9490731858503091, -0.3191583692779135, -0.17272051715342662, -0.0675768762689292, -1.7245976716774256, -0.2895078050559988, 0.9038686104869157, 0.5033106435514135, -0.6745123356981777, 0.13284663628852594, 1.3773784906151905, 1.415181082205749, 0.6526521055357533, 0.07592158643983254, 0.002246656656384366, -0.14714869674656006, 0.5731126290825953, 1.6156693324820386, 0.913434176694768, 0.25822977344206843, -10.307318894292925], 'output': 0.982737938352028, 'delta': -2.318838417385038e-06}, {'weights': [0.7907872557641347, 0.5671480208757321, 0.39143664948803214, 0.27755098755688856, 0.09748246209396116, 0.8036291185152119, 0.11142476344895884, 0.7358880139872477, 0.5405540220657239, 0.9589409770315054, 0.7690551900301327, 0.9775383158449078, 0.14053520432463681, 0.5037185434434505, 0.5747320961103637, 0.31049848189814583, 0.5167786209786545, 0.3684876923239462, 0.5332686858667597, 0.002579570413401023, 0.4450669186198555, 0.4549825178977667, 0.3075451848823505, 0.4135464081354971, 0.7954213634199178, 0.6895157896922002, 0.4926008133038967, 0.6409624954524014, 0.3730535421977938, 0.20141809239155611, 0.004881480332684354, 0.27859320505035867, 0.5974566904491257, 0.8807126595539273, 0.8265342761020988, 0.5141278777639576, 0.9955892066744865, 0.4740180264473929, 0.8407980592074483, 0.4127905126732926, 0.7640234117442667, 1.0011725019670543, 0.3150912575172273, 1.00119313770447], 'output': 0.9998238420135678, 'delta': -4.130839437089694e-09}, {'weights': [4.482876053514841, 4.9803317137586856, -0.45196161525011286, 0.35503284252310446, -1.093207703378098, -0.29759737949414267, 0.4925085808561198, -1.1845018141387482, -0.8239800303557425, 0.6444007361228035, 1.0803016742155729, 1.5218005105151686, 1.8295606585464763, 2.0952476612681306, -0.024397432604621457, -0.36318840504434874, -1.1806794682645427, 0.8754814829696589, 0.21439532866033562, 0.751383198391257, 0.46389986301919356, 1.038327150055743, 2.2824186914806273, 0.8913280562791284, 0.7626973171650174, 0.7028541843465483, -0.5766606941361795, -2.9645451509743506, -0.8901669456645905, 1.3503649205859054, 0.45257366866309157, -1.075927230329316, 0.25978984044764153, 0.9029134941038178, 1.710422387209671, -0.5028500723565855, 0.6269558148520308, 0.3584091461308793, -0.2206000615510913, 0.41704426581311754, 2.870192872040981, 1.9721726116392742, 0.644686997790701, -5.262843911547205], 'output': 0.9910043747489076, 'delta': -2.4052275386893785e-06}, {'weights': [3.538324036486006, 1.7900116618859552, 0.8623584718231795, 0.5793620768092076, 0.6526646885893237, -0.6662093978068977, 0.9742821843475648, 0.5658499542602154, -1.104245224795647, 0.32890259811464634, 0.12693779895566137, 0.6895755977930871, 0.09774266877908785, 0.31084733024996225, -0.916074269286329, -0.0230377194610604, 1.0566114554231028, 2.486582981362758, 1.3664203977742302, 0.9883875203957325, 1.0228191361730965, 0.48037393265763295, 0.39547291417322405, 1.2838039741801908, 0.7248394934358658, 0.2200121857812256, -0.1748002639403299, -0.3459008001305619, -0.41226303091705957, 1.0597178088508983, -0.15524986854219386, 0.049167073525372626, 0.5327250118976173, 0.7089615895318002, 1.3050068946701219, 1.0850538122121085, 0.40881213763353236, -0.23621690489890257, 0.0003217791248745788, 0.006666950671917664, 1.9008339971682129, 0.9483880463192067, 0.8274517599073664, -10.314434400384728], 'output': 0.9669884296458784, 'delta': 3.0623963182952004e-06}],[{'weights': [0.3883953775897621, 0.07340088897148281, 0.35232101033552743, 3.062248717002623, -0.05468402840767834, 0.5305800847405029, 2.859777296980757, 0.6400338204820649, 0.03164559911631843, 0.530039878465602, -2.0957356982748547, 0.10737018771062617, -7.524805735594536, -3.055248174944787, -2.155667407036339], 'output': 0.0021754547937905743, 'delta': -4.7223079947250565e-06}, {'weights': [-0.28705600158149264, -0.23205485859067332, -0.3523428969291917, 4.006959061951455, 0.4723865220563823, -0.18737526555694792, -9.91789240663384, 0.2943247357011599, 0.42425555357413897, 0.5386449381043888, 2.624434986118679, -0.07295995828758331, 3.6533187954083406, -0.25362777216659205, -5.26496600007783], 'output': 0.00964229681163693, 'delta': -9.207740598176855e-05}, {'weights': [-0.8464630647778543, -0.6257644333357952, -0.436656330581765, 5.880354096775355, -0.8407962416360699, -0.7331710613500024, 7.538249441413545, -0.47713228913619676, -0.40626172198866245, -0.8251116094403614, 4.249177023715662, -0.6799434283219692, 4.01155088428366, 3.906264068173889, -13.89419160399936], 'output': 0.9961408826157152, 'delta': 1.4835313972532185e-05}, {'weights': [-0.15907151172891615, 0.6641080399650985, 0.5946753590083238, -9.243823668052444, 0.2430872959024894, 0.37979413535431533, 0.7239703369556202, 0.15396452415634165, 0.7149319963624234, 0.6441443580684934, -1.275547555342825, 0.7794566265668237, 1.1333274868181153, -0.008241917895549709, -0.6829579166711284], 'output': 0.005023710248252542, 'delta': -2.511087794381126e-05}]
]

for row in test_data:
    prediction = 0
    print('row', row)
    prediction = predict(network, row)
    print(prediction)
    if prediction == 3:
        prediction = 0
    else:
        prediction = prediction + 1

    print('Expected=%d, Got=%d' % (int(row[-1]), prediction))
